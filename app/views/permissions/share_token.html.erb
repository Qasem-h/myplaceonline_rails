<% content_for :heading do -%><%= t('myplaceonline.permissions.share_token') %><% end -%>
<h1><%= t('myplaceonline.permissions.share_token') %></h1>
<%= flashes! %>
<% if @share.errors.any? %>
  <div class="errors">
    <ul>
    <% @share.errors.full_messages.each do |msg| %>
      <li><%= msg %></li>
    <% end %>
    </ul>
  </div>
<% end %>

<%= form_for @share, :url => permissions_share_token_path do |f| %>
  <%= myp_text_field(f, :subject, "myplaceonline.permissions.subject", @share.subject, true) %>
  <%= myp_text_area_markdown(f, :body, "myplaceonline.permissions.body", @share.body) %>
  <%= myp_check_box(f, :copy_self, "myplaceonline.permissions.copy_self") %>
  <%= myp_hidden_field(f, :email, @share.email) %>
  <%= myp_hidden_field(f, :subject_class, @share.subject_class) %>
  <%= myp_hidden_field(f, :subject_id, @share.subject_id) %>
  <%=
    render layout: 'myplaceonline/childproperties', locals: {
      f: f,
      heading: t("myplaceonline.permissions.contacts"),
      childpropertiesname: :permission_share_contacts,
      childproperties: @share.permission_share_contacts,
      deletebutton: t("myplaceonline.permissions.delete_contact"),
      addbutton: t("myplaceonline.permissions.add_contact"),
      expanded: true,
      formjson: [
        {
          type: :renderpartial,
          name: :contact_attributes,
          partial: 'myplaceonline/select_or_create',
          heading: t("myplaceonline.permissions.contact"),
          objform: "contacts/form",
          existingobjurl: "contact_path",
          searchurl: "/contacts.json?perpage=0",
          edit: true,
          autofocus: true,
          force_existing: true
        }
      ]
    } do |child_fields, childproperty|
  %>
    <%=
      render partial: 'myplaceonline/select_or_create', locals: {
        f: child_fields,
        name: :contact_attributes,
        existingobj: childproperty.contact,
        heading: t("myplaceonline.permissions.contact"),
        objform: "contacts/form",
        existingobjurl: "contact_path",
        searchurl: "/contacts.json?perpage=0",
        edit: true,
        autofocus: false
      }
    %>
  <% end %>
  
  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div data-role="navbar">
      <ul>
        <li>
          <%= f.submit(t("myplaceonline.permissions.share"), "data-icon" => "action", "data-iconpos" => "top") %>
        </li>
        <li><%= link_to t("myplaceonline.general.cancel"), "/", "data-icon" => "back" %></li>
      </ul>
    </div>
  </div>
<% end %>

<script type="text/javascript">
  myplaceonline.onPageLoad(function() {
    myplaceonline.maybeFocus(".autofocus");
  });
</script>
