<%= f.fields_for :ref, obj.ref do |identity_fields| %>

  <%= myp_text_field identity_fields, :name, "myplaceonline.contacts.name", obj.name, autofocus %>
  <%= myp_date_field identity_fields, :birthday, "myplaceonline.contacts.birthday", obj.birthday %>
  <%= myp_text_area_markdown identity_fields, :notes, "myplaceonline.contacts.notes", obj.notes %>
  
  <%=
    render layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.emails"),
      childpropertiesname: :identity_emails,
      childproperties: obj.contact_identity.identity_emails,
      deletebutton: t("myplaceonline.identities.delete_email"),
      addbutton: t("myplaceonline.identities.add_email"),
      expanded: obj.contact_identity.identity_emails.length > 0,
      formjson: [
        {
          type: 'text',
          name: 'email',
          placeholder: t("myplaceonline.identities.email"),
          autofocus: true
        }
      ]
    } do |child_fields, childproperty|
  %>
    <%= myp_text_field child_fields, :email, "myplaceonline.identities.email", childproperty.email %>
  <% end %>

  <%=
    render layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.phones"),
      childpropertiesname: :identity_phones,
      childproperties: obj.contact_identity.identity_phones,
      deletebutton: t("myplaceonline.identities.delete_phone"),
      addbutton: t("myplaceonline.identities.add_phone"),
      expanded: obj.contact_identity.identity_phones.length > 0,
      formjson: [
        {
          type: 'text',
          name: 'number',
          placeholder: t("myplaceonline.identities.phone"),
          autofocus: true
        }
      ]
    } do |child_fields, childproperty|
  %>
    <%= myp_text_field child_fields, :number, "myplaceonline.identities.phone", childproperty.number %>
  <% end %>

  <%=
    render layout: 'myplaceonline/childproperties', locals: {
      f: f,
      heading: t("myplaceonline.contacts.conversations"),
      childpropertiesname: :conversations,
      childproperties: obj.all_conversations,
      deletebutton: t("myplaceonline.contacts.delete_conversation"),
      addbutton: t("myplaceonline.contacts.add_conversation"),
      expanded: obj.all_conversations.length > 0,
      formjson: [
        {
          type: 'textarea',
          name: 'conversation',
          placeholder: t("myplaceonline.contacts.conversation"),
          autofocus: true
        },
        {
          type: 'date',
          name: 'when',
          placeholder: t("myplaceonline.contacts.conversation_date")
        }
      ]
    } do |child_fields, childproperty|
  %>
    <%= myp_text_area child_fields, :conversation, "myplaceonline.contacts.conversation", childproperty.conversation %>
    <%= myp_date_field child_fields, :when, "myplaceonline.contacts.conversation_date", childproperty.when %>
  <% end %>

  <%=
    render layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.locations"),
      childpropertiesname: :identity_locations,
      childproperties: obj.contact_identity.identity_locations,
      deletebutton: t("myplaceonline.identities.delete_location"),
      addbutton: t("myplaceonline.identities.add_location"),
      expanded: obj.contact_identity.identity_locations.length > 0,
      formjson: [
        {
          type: :renderpartial,
          name: :location_attributes,
          partial: 'myplaceonline/select_or_create',
          heading: t("myplaceonline.identities.location"),
          objform: "locations/form",
          existingobjurl: "location_path",
          searchurl: "/locations.json?perpage=0",
          edit: false,
          autofocus: true
        }
      ]
    } do |child_fields, childproperty|
  %>
    <%=
      render partial: 'myplaceonline/select_or_create', locals: {
        f: child_fields,
        name: :location_attributes,
        existingobj: childproperty.location,
        heading: t("myplaceonline.identities.location"),
        objform: "locations/form",
        existingobjurl: "location_path",
        searchurl: "/locations.json?perpage=0",
        edit: edit,
        autofocus: false
      }
    %>
  <% end %>
  
  <%=
    render layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.drivers_licenses"),
      childpropertiesname: :identity_drivers_licenses,
      childproperties: obj.contact_identity.identity_drivers_licenses,
      deletebutton: t("myplaceonline.identities.delete_license"),
      addbutton: t("myplaceonline.identities.add_license"),
      expanded: obj.contact_identity.identity_drivers_licenses.length > 0,
      formjson: [
        {
          type: 'text',
          name: 'identifier',
          placeholder: t("myplaceonline.identities.license_number"),
          autofocus: true
        },
        {
          type: 'date',
          name: 'expires',
          placeholder: t("myplaceonline.identities.license_expires")
        }
      ]
    } do |child_fields, childproperty|
  %>
    <%= myp_text_field child_fields, :identifier, "myplaceonline.identities.license_number", childproperty.identifier %>
    <%= myp_date_field child_fields, :expires, "myplaceonline.identities.license_expires", childproperty.expires %>
    <%= myp_region_field child_fields, :region, "myplaceonline.general.region", childproperty.region %>
    <%= myp_subregion_field child_fields, :sub_region1, "myplaceonline.general.sub_region1", childproperty.region, childproperty.sub_region1 %>
    <%= child_fields.fields_for :identity_file, childproperty.identity_file || IdentityFile.new do |file_fields| %>
      <%= myp_file_field file_fields, :file, "myplaceonline.identities.license_picture", childproperty.identity_file || IdentityFile.new %>
    <% end %>
  <% end %>

<% end %>
