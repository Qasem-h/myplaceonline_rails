<%= f.fields_for(:contact_identity, obj.contact_identity) do |identity_fields| %>

  <%= myp_text_field(identity_fields, :name, "myplaceonline.contacts.name", obj.contact_identity.name, autofocus) %>
  <%= myp_text_field(identity_fields, :nickname, "myplaceonline.contacts.nickname", obj.contact_identity.nickname) %>
  <%= myp_date_field(identity_fields, :birthday, "myplaceonline.contacts.birthday", obj.contact_identity.birthday) %>
  <%= myp_select(f, :contact_type, "myplaceonline.contacts.contact_type", Myp.translate_options(Contact::CONTACT_TYPES), obj.contact_type) %>
  
  <%=
    render(layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.emails"),
      childpropertiesname: :identity_emails,
      childproperties: obj.contact_identity.identity_emails,
      deletebutton: t("myplaceonline.identities.delete_email"),
      addbutton: t("myplaceonline.identities.add_email"),
      expanded: obj.contact_identity.identity_emails.length > 0,
      formjson: [
        {
          type: 'text',
          name: 'email',
          placeholder: t("myplaceonline.identities.email"),
          autofocus: true
        }
      ]
    }) do |child_fields, childproperty|
  %>
    <%= myp_text_field(child_fields, :email, "myplaceonline.identities.email", childproperty.email) %>
  <% end %>

  <%=
    render(layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.phones"),
      childpropertiesname: :identity_phones,
      childproperties: obj.contact_identity.identity_phones,
      deletebutton: t("myplaceonline.identities.delete_phone"),
      addbutton: t("myplaceonline.identities.add_phone"),
      expanded: obj.contact_identity.identity_phones.length > 0,
      formjson: [
        {
          type: 'text',
          name: 'number',
          placeholder: t("myplaceonline.identities.phone"),
          autofocus: true
        },
        {
          type: 'select',
          name: 'phone_type',
          options: IdentityPhone::PHONE_TYPES.map{|x,y| [I18n.t(x),y]}.as_json,
          placeholder: t("myplaceonline.identity_phones.phone_type")
        }
      ]
    }) do |child_fields, childproperty|
  %>
    <%= myp_text_field(child_fields, :number, "myplaceonline.identities.phone", childproperty.number) %>
    <%= myp_select(child_fields, :phone_type, "myplaceonline.identity_phones.phone_type", Myp.translate_options(IdentityPhone::PHONE_TYPES), childproperty.phone_type) %>
  <% end %>

  <%=
    render(layout: 'myplaceonline/childproperties', locals: {
      f: f,
      heading: t("myplaceonline.contacts.conversations"),
      childpropertiesname: :conversations,
      childproperties: obj.all_conversations,
      deletebutton: t("myplaceonline.contacts.delete_conversation"),
      addbutton: t("myplaceonline.contacts.add_conversation"),
      expanded: false,
      formjson: [
        {
          type: 'textarea',
          name: 'conversation',
          placeholder: t("myplaceonline.contacts.conversation"),
          autofocus: true
        },
        {
          type: 'date',
          name: 'conversation_date',
          placeholder: t("myplaceonline.contacts.conversation_date"),
          value: Date.today.to_s
        }
      ]
    }) do |child_fields, childproperty|
  %>
    <%= myp_text_area(child_fields, :conversation, "myplaceonline.contacts.conversation", childproperty.conversation) %>
    <%= myp_date_field(child_fields, :conversation_date, "myplaceonline.contacts.conversation_date", childproperty.conversation_date) %>
  <% end %>

  <%=
    render(layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.locations"),
      childpropertiesname: :identity_locations,
      childproperties: obj.contact_identity.identity_locations,
      deletebutton: t("myplaceonline.identities.delete_location"),
      addbutton: t("myplaceonline.identities.add_location"),
      expanded: obj.contact_identity.identity_locations.length > 0,
      formjson: [
        {
          type: :renderpartial,
          name: :location_attributes,
          partial: 'myplaceonline/select_or_create',
          heading: t("myplaceonline.identities.location"),
          objform: "locations/form",
          existingobjurl: "location_path",
          searchurl: "/locations.json?perpage=0",
          edit: false,
          autofocus: true
        }
      ]
    }) do |child_fields, childproperty|
  %>
    <%=
      render partial: 'myplaceonline/select_or_create', locals: {
        f: child_fields,
        name: :location_attributes,
        existingobj: childproperty.location,
        heading: t("myplaceonline.identities.location"),
        objform: "locations/form",
        existingobjurl: "location_path",
        searchurl: "/locations.json?perpage=0",
        edit: edit,
        autofocus: false
      }
    %>
  <% end %>
  
  <%=
    render(layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.relationships"),
      childpropertiesname: :identity_relationships,
      childproperties: obj.contact_identity.identity_relationships,
      deletebutton: t("myplaceonline.identities.delete_relationship"),
      addbutton: t("myplaceonline.identities.add_relationship"),
      expanded: obj.contact_identity.identity_relationships.length > 0,
      formjson: [
        {
          type: :renderpartial,
          name: :contact_attributes,
          partial: 'myplaceonline/select_or_create',
          heading: t("myplaceonline.contacts.contact"),
          objform: "contacts/form",
          existingobjurl: "contact_path",
          searchurl: "/contacts.json?perpage=0",
          edit: true,
          autofocus: true
        },
        {
          type: 'select',
          name: 'relationship_type',
          options: IdentityRelationship::RELATIONSHIPS.map{|x,y| [I18n.t(x),y]}.as_json,
          placeholder: t("myplaceonline.identity_relationships.relationship_type")
        }
      ]
    }) do |child_fields, childproperty|
  %>
    <%=
      render partial: 'myplaceonline/select_or_create', locals: {
        f: child_fields,
        name: :contact_attributes,
        existingobj: childproperty.contact,
        heading: t("myplaceonline.contacts.contact"),
        objform: "contacts/form",
        existingobjurl: "contact_path",
        searchurl: "/contacts.json?perpage=0",
        edit: true,
        autofocus: false
      }
    %>
    <%= myp_select(child_fields, :relationship_type, "myplaceonline.identity_relationships.relationship_type", Myp.translate_options(IdentityRelationship::RELATIONSHIPS), childproperty.relationship_type) %>
  <% end %>
  
  <%=
    render(layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.identities.drivers_licenses"),
      childpropertiesname: :identity_drivers_licenses,
      childproperties: obj.contact_identity.identity_drivers_licenses,
      deletebutton: t("myplaceonline.identities.delete_license"),
      addbutton: t("myplaceonline.identities.add_license"),
      expanded: obj.contact_identity.identity_drivers_licenses.length > 0,
      formjson: [
        {
          type: 'text',
          name: 'identifier',
          placeholder: t("myplaceonline.identities.license_number"),
          autofocus: true
        },
        {
          type: 'date',
          name: 'expires',
          placeholder: t("myplaceonline.identities.license_expires")
        }
      ]
    }) do |child_fields, childproperty|
  %>
    <%= myp_text_field(child_fields, :identifier, "myplaceonline.identities.license_number", childproperty.identifier) %>
    <%= myp_date_field(child_fields, :expires, "myplaceonline.identities.license_expires", childproperty.expires) %>
    <%= myp_region_field(child_fields, :region, "myplaceonline.general.region", childproperty.region) %>
    <%= myp_subregion_field(child_fields, :sub_region1, "myplaceonline.general.sub_region1", childproperty.region, childproperty.sub_region1) %>
    <%= child_fields.fields_for(:identity_file, childproperty.identity_file || IdentityFile.new) do |file_fields| %>
      <%= myp_file_field(file_fields, :file, "myplaceonline.identities.license_picture", childproperty.identity_file || IdentityFile.new) %>
    <% end %>
  <% end %>
  
  <%=
    render(layout: 'myplaceonline/childproperties', locals: {
      f: identity_fields,
      heading: t("myplaceonline.contacts.pictures"),
      childpropertiesname: :identity_pictures,
      childproperties: obj.contact_identity.identity_pictures,
      deletebutton: t("myplaceonline.contacts.delete_picture"),
      addbutton: t("myplaceonline.contacts.add_picture"),
      expanded: obj.contact_identity.identity_pictures.length > 0,
      formjson: [
        {
          type: 'file',
          name: 'identity_file_attributes.file',
          placeholder: t("myplaceonline.contacts.picture")
        }
      ]
    }) do |child_fields, childproperty|
  %>
    <%= child_fields.fields_for(:identity_file, childproperty.identity_file) do |file_fields| %>
      <%= myp_file_field(file_fields, :file, "myplaceonline.contacts.picture", childproperty.identity_file.file) %>
    <% end %>
  <% end %>

  <%= myp_text_area_markdown(identity_fields, :notes, "myplaceonline.contacts.notes", obj.contact_identity.notes) %>
  <%= myp_text_area_markdown(identity_fields, :likes, "myplaceonline.contacts.likes", obj.contact_identity.likes) %>
  <%= myp_text_area_markdown(identity_fields, :gift_ideas, "myplaceonline.contacts.gift_ideas", obj.contact_identity.gift_ideas) %>
  <%= myp_text_field(identity_fields, :ktn, "myplaceonline.contacts.ktn", obj.contact_identity.ktn) %>

<% end %>
